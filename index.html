<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joinville Segura</title>
    <!-- Tailwind CSS para o visual moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .elderly-text { font-size: 1.25rem; line-height: 1.75rem; font-weight: 700; }
        input, select, textarea { font-size: 1.25rem !important; font-weight: 600 !important; }
        button { transition: all 0.2s; }
        button:active { transform: scale(0.95); }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos de borda por status */
        .status-border-pendente { border-left-color: #ef4444 !important; } /* Vermelho */
        .status-border-andamento { border-left-color: #f59e0b !important; } /* Amarelo */
        .status-border-concluido { border-left-color: #10b981 !important; } /* Verde */
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "lucide-react": "https://esm.sh/lucide-react@^0.564.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200 min-h-screen">

    <div id="root" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- O conte√∫do ser√° injetado via React/DOM -->
    </div>

    <script>
        // --- T√âCNICA JSONP GLOBAL ---
        let registroParaEditar = null; // Vari√°vel de Suporte
        window.ultimosRegistros = []; // Captura de Dados na Busca
        window.lastData = null;
        window.handleGoogleData = function(data) {
            let parsedData = data;
            if (typeof data === 'string') {
                try {
                    parsedData = JSON.parse(data);
                } catch (e) {
                    console.error("Erro ao processar JSON da string recebida:", e);
                }
            }
            window.lastData = parsedData;
        };

        // --- CONFIGURA√á√ïES E CONSTANTES ---
        const DIRECT_URL = 'https://script.google.com/macros/s/AKfycbzn2NSn77z4nsNOyDSyfT5_YKBLimBdN4X1oVa0MSxJbpqIjFrCuJ4rwhpiRSyBrE1l/exec';
        const ADMIN_PASSWORD_LOCAL = '30012026';
        let appVersionStr = "Carregando...";

        // --- ESTADO GLOBAL DO APLICATIVO ---
        let state = {
            screen: 'home',
            darkMode: false,
            currentTime: new Date(),
            registrations: [],
            consegs: [],
            loading: false,
            isAdminAuthenticated: false,
            adminTab: 'registros',
            adminEditingConseg: null,
            filterPeriodStart: '',
            filterPeriodEnd: '',
            filterStatus: 'Todos', // "Todos", "Aberto", "Em andamento", "Solucionado", "Fechado"
            filterConseg: '',
            ouvidoriaUser: '',
            ouvidoriaPass: '',
            ouvidoriaEditingId: null,
            ouvidoriaView: 'login',
            presidentView: 'login', // login, dashboard
            currentUser: null,
            formSubject: '',
            formConsegId: '',
            formProcessNumber: '',
            formProcessDate: '',
            formStatus: 'Aberto',
            ouvidoriaListFilterStatus: '',
            adminAttempts: 0,
            presidentAttempts: 0
        };

        // --- SEGURAN√áA (Panic Mode Silencioso via API) ---
        function sendSecurityAlert() {
            const blockApp = () => {
                window.location.replace('about:blank');
            };

            const triggerAlert = (loc) => {
                const payload = {
                    type: 'security_alert',
                    payload: {
                      location: loc,
                      source: 'Login Errado',
                      timestamp: new Date().toLocaleString('pt-BR')
                    }
                };

                fetch(DIRECT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                }).finally(() => {
                    blockApp();
                });

                setTimeout(blockApp, 2000);
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => triggerAlert(`${pos.coords.latitude},${pos.coords.longitude}`),
                    () => triggerAlert('Localiza√ß√£o negada/indispon√≠vel'),
                    { timeout: 5000 }
                );
            } else {
                triggerAlert('Geolocaliza√ß√£o n√£o suportada');
            }
        }

        // --- BUSCA DE VERS√ÉO AUTOM√ÅTICA ---
        function fetchAppVersion() {
            fetch(window.location.href, { method: 'HEAD' })
                .then(response => {
                    const lastModified = response.headers.get('Last-Modified');
                    if (lastModified) {
                        appVersionStr = new Date(lastModified).toLocaleString('pt-BR');
                        const verSpan = document.getElementById('appVersion');
                        if (verSpan) verSpan.innerText = appVersionStr;
                    } else {
                        appVersionStr = "Atualizado em " + new Date().toLocaleString('pt-BR');
                    }
                })
                .catch(() => {
                    appVersionStr = "Vers√£o Indispon√≠vel";
                });
        }

        // --- COMUNICA√á√ÉO JSONP ---
        let dataPollingInterval = null;

        function fetchDataJSONP(force = false) {
            if (!force && (state.ouvidoriaView === 'form' || state.adminEditingConseg || (state.screen === 'president' && state.presidentView === 'dashboard'))) {
                return;
            }

            state.loading = true;
            window.lastData = null; 
            render();

            const oldScript = document.getElementById('google-script-loader');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'google-script-loader';
            script.src = `${DIRECT_URL}?callback=handleGoogleData&t=${Date.now()}`;
            document.body.appendChild(script);

            const startTime = Date.now();
            if (dataPollingInterval) clearInterval(dataPollingInterval);

            return new Promise((resolve) => {
                dataPollingInterval = setInterval(() => {
                    if (window.lastData) {
                        processIncomingData(window.lastData);
                        clearInterval(dataPollingInterval);
                        state.loading = false;
                        render();
                        resolve();
                    }
                    if (Date.now() - startTime > 20000) {
                        clearInterval(dataPollingInterval);
                        state.loading = false;
                        render();
                        resolve();
                    }
                }, 500);
            });
        }

        function processIncomingData(data) {
            if (data && data.consegs) {
                state.consegs = data.consegs.map(c => ({
                    id: c.id || '',
                    nome: c.nome || '',
                    senha: String(c.senha || ''),
                    ativo: String(c.ativo).toLowerCase() === 'true',
                    email: c.email || '',
                    agenda: c.agenda || ''
                }));
            }

            if (data && data.registrations) {
                // Ajuste de chaves para min√∫sculas conforme solicitado (compatibilidade com novo codigo.gs)
                const regs = data.registrations.map(r => ({
                    id: r.id || '',
                    userName: r.username || r.userName || '',
                    userPassword: r.userpassword || r.userPassword || '',
                    consegId: r.consegid || r.consegId || '',
                    subject: r.subject || '',
                    processNumber: r.processnumber || r.processNumber || '',
                    processDate: r.processdate || r.processDate || '',
                    status: r.status || 'Aberto',
                    createdAt: r.createdat || r.createdAt || new Date().toISOString(),
                    updatedAt: r.updatedat || r.updatedAt || r.createdAt || r.createdat || new Date().toISOString(),
                    latitude: r.latitude || null,
                    longitude: r.longitude || null
                }));
                state.registrations = regs;
                window.ultimosRegistros = regs; 
            }
        }

        function setScreen(scr) { 
            state.screen = scr; 
            state.adminEditingConseg = null; 
            state.presidentView = 'login'; 
            render(); 
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.documentElement.classList.toggle('dark', state.darkMode);
            render();
        }

        function render() {
            const root = document.getElementById('root');
            const dateStr = state.currentTime.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = state.currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            let content = `
                <header class="text-center mb-8 animate-fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <div class="w-10"></div>
                        <h1 class="text-3xl md:text-5xl font-extrabold text-primary dark:text-blue-400">Joinville Segura</h1>
                        <button onclick="toggleDarkMode()" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700">
                            ${state.darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                    <p class="text-xl md:text-2xl font-bold text-gray-700 dark:text-gray-300 text-center">Sistema Comunit√°rio de Seguran√ßa P√∫blica</p>
                    <p class="text-lg font-bold text-gray-500 mt-2 text-center">${formattedDate} ${timeStr}</p>
                </header>
                
                <main id="app-main">
                    ${renderScreen()}
                </main>

                ${state.screen === 'home' ? renderFooter() : ''}
            `;

            root.innerHTML = content;
        }

        function renderScreen() {
            switch(state.screen) {
                case 'home': return renderHome();
                case 'ouvidoria': return renderOuvidoria();
                case 'emergencia': return renderEmergencia();
                case 'servicos': return renderServicos();
                case 'agenda': return renderAgenda();
                case 'admin': return renderAdmin();
                case 'president': return renderPresident();
                default: return renderHome();
            }
        }

        function renderHome() {
            const buttons = [
                { label: "Abrir OUVIDORIA na Prefeitura de Joinville (App Joinville F√°cil)", color: "bg-blue-600", icon: "üè¢", click: "window.open('https://oauthexternal.joinville.sc.gov.br/')" },
                { label: "Registrar no CONSEG a OUVIDORIA da Prefeitura de Joinville", color: "bg-indigo-600", icon: "üìù", click: "setScreen('ouvidoria')" },
                { label: "Acessar o APP PMSC Cidad√£o da Pol√≠cia Militar", color: "bg-emerald-600", icon: "üëÆ", click: "window.open('https://www.pm.sc.gov.br/')" },
                { label: "Registrar Boletim de Ocorr√™ncia (B.O.) na Pol√≠cia Civil", color: "bg-red-600", icon: "üìë", click: "window.open('https://delegaciavirtual.sc.gov.br/')" },
                { label: "SINESP Cidad√£o (Consultar ve√≠culo pela placa)", color: "bg-yellow-600", icon: "üöó", click: "window.open('https://play.google.com/store/apps/details?id=br.gov.sinesp.cidadao.android')" },
                { label: "CELESC (Energia El√©trica)", color: "bg-orange-600", icon: "‚ö°", click: "window.open('https://play.google.com/store/apps/details?id=br.com.celesc.app')" },
                { label: "Telefones de EMERG√äNCIA", color: "bg-rose-600", icon: "üö®", click: "setScreen('emergencia')" },
                { label: "Telefones de SERVI√áOS", color: "bg-teal-600", icon: "üõ†Ô∏è", click: "setScreen('servicos')" },
                { label: "Agenda do CONSEG", color: "bg-purple-600", icon: "üìÖ", click: "setScreen('agenda')" },
                { label: "Intelig√™ncia Artificial ChatGPT", color: "bg-cyan-600", icon: "ü§ñ", click: "window.open('https://chatgpt.com/')" }
            ];

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                    ${buttons.map(b => `
                        <button onclick="${b.click}" class="${b.color} text-white p-6 rounded-2xl shadow-xl flex items-center gap-4 text-left elderly-text min-h-[110px] hover:scale-[1.02] transition-transform">
                            <span class="text-4xl bg-white/20 p-2 rounded-xl">${b.icon}</span>
                            <span>${b.label}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="mt-12 bg-gray-100 dark:bg-gray-800 p-6 rounded-3xl border-2 border-dashed border-gray-400 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2 text-primary dark:text-blue-400">üõ°Ô∏è √Årea Administrativa</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button onclick="setScreen('president')" class="bg-slate-700 text-white p-4 rounded-xl font-bold hover:bg-slate-800 transition-colors">Presidente de CONSEG</button>
                        <button onclick="setScreen('admin')" class="bg-slate-700 text-white p-4 rounded-xl font-bold hover:bg-slate-800 transition-colors">Painel Admin</button>
                        <button onclick="window.close()" class="bg-red-900 text-white p-4 rounded-xl font-bold hover:bg-red-800 transition-colors">Sair do Aplicativo</button>
                    </div>
                </div>
                
                <footer class="mt-8 pt-8 border-t text-center space-y-4 animate-fade-in">
                    <div class="flex flex-col gap-2 items-center">
                        <a href="https://cepcc.ssp.sc.gov.br/" target="_blank" class="text-sm font-bold text-blue-700 dark:text-blue-400 hover:underline">Saiba mais sobre os CONSEGs em cepcc.ssp.sc.gov.br</a>
                        <a href="mailto:ConsegComasaEspinheiros@Gmail.com" class="text-sm font-bold text-blue-700 dark:text-blue-400 hover:underline">Reportar um problema com este aplicativo</a>
                    </div>
                    
                    <p class="text-lg font-bold text-gray-600 dark:text-gray-400 px-4">Este aplicativo "Joinville Segura" foi idealizado por Marcos Roberto Martins - Membro do Conselho Comunit√°rio de Seguran√ßa CONSEG Comasa e Espinheiros desde 2017.</p>
                    
                    <p class='text-[10px] text-gray-400 mt-4 uppercase tracking-widest'>Vers√£o: <span id='appVersion'>${appVersionStr}</span></p>
                </footer>
            `;
        }

        function renderAdmin() {
            if (!state.isAdminAuthenticated) {
                return `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 max-w-md mx-auto animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Painel Administrativo</h2>
                        <input type="password" id="admin-pass" placeholder="Senha do Sistema" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold text-2xl">
                        <button onclick="handleAdminLogin()" class="w-full p-5 bg-slate-700 text-white rounded-xl font-bold text-2xl shadow-lg">Entrar</button>
                        <button onclick="setScreen('home')" class="w-full p-4 text-gray-500 font-bold text-lg">Voltar √† Home</button>
                    </div>
                `;
            }

            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center border-b pb-4">
                        <h2 class="text-3xl font-extrabold text-primary dark:text-blue-400">Painel Administrativo</h2>
                        <button onclick="state.isAdminAuthenticated = false; render();" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold">Sair</button>
                    </div>
                    <div class="flex bg-gray-100 dark:bg-gray-700 p-2 rounded-2xl gap-2">
                        <button onclick="state.adminTab = 'registros'; render();" class="flex-1 p-4 rounded-xl font-bold ${state.adminTab === 'registros' ? 'bg-white shadow text-primary' : 'text-gray-500'}">üìã Registros</button>
                        <button onclick="state.adminTab = 'consegs'; render();" class="flex-1 p-4 rounded-xl font-bold ${state.adminTab === 'consegs' ? 'bg-white shadow text-primary' : 'text-gray-500'}">üõ°Ô∏è CONSEGs</button>
                    </div>
                    ${state.adminTab === 'registros' ? renderAdminRegistros() : renderAdminConsegs()}
                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-xl">Voltar ao Menu</button>
                </div>
            `;
        }

        function handleAdminLogin() {
            const passVal = document.getElementById('admin-pass').value;
            if (passVal === ADMIN_PASSWORD_LOCAL) { 
                state.isAdminAuthenticated = true; 
                state.adminAttempts = 0; 
                render(); 
                fetchDataJSONP(); 
            } else {
                state.adminAttempts++;
                if (state.adminAttempts >= 3) {
                    sendSecurityAlert();
                } else {
                    alert('Senha Incorreta!');
                }
            }
        }

        function renderAdminConsegs() {
            if (state.adminEditingConseg) {
                const c = state.adminEditingConseg;
                const isNew = !c.id;
                return `
                    <div class="p-8 bg-gray-50 dark:bg-gray-700 rounded-3xl border-2 border-primary/30 space-y-6 animate-fade-in shadow-xl">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-black text-primary uppercase">${isNew ? '‚ú® Incluir Novo CONSEG' : '‚úèÔ∏è Editando: ' + c.nome}</h3>
                            <button onclick="state.adminEditingConseg = null; render();" class="text-red-500 hover:scale-110 transition-transform font-bold text-2xl">‚úï</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2 space-y-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">Nome Oficial do CONSEG</label>
                                <input type="text" id="edit-nome" value="${c.nome || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-600 font-bold focus:border-primary outline-none" placeholder="Ex: CONSEG Joinville Leste">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">E-mail de Contato</label>
                                <input type="email" id="edit-email" value="${c.email || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-600 font-bold focus:border-primary outline-none" placeholder="exemplo@gmail.com">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">Senha de Acesso</label>
                                <input type="text" id="edit-senha" value="${c.senha || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-600 font-bold focus:border-primary outline-none" placeholder="Senha do Presidente">
                            </div>
                            <div class="md:col-span-2 space-y-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">Agenda e Reuni√µes</label>
                                <textarea id="edit-agenda" class="w-full p-4 border rounded-xl dark:bg-gray-600 font-bold h-32 focus:border-primary outline-none" placeholder="Local, data e hor√°rio das reuni√µes...">${c.agenda || ''}</textarea>
                            </div>
                            <div class="md:col-span-2 space-y-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">Situa√ß√£o (Ativo no App)</label>
                                <select id="edit-ativo" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:border-primary outline-none">
                                    <option value="true" ${c.ativo ? 'selected' : ''}>Sim (Ativo)</option>
                                    <option value="false" ${!c.ativo ? 'selected' : ''}>N√£o (Inativo)</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="${isNew ? 'saveNewConseg()' : 'updateConsegData()'}" class="flex-1 p-5 bg-green-600 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-green-700 transition-colors">
                                ${isNew ? '‚úÖ Confirmar Cadastro' : 'üíæ Salvar Altera√ß√µes'}
                            </button>
                            <button onclick="state.adminEditingConseg = null; render();" class="flex-1 p-5 bg-gray-500 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-gray-600 transition-colors">Cancelar</button>
                        </div>
                    </div>
                `;
            }

             return `
                <div class="space-y-4 animate-fade-in">
                    <button onclick="addNewConseg()" class="w-full p-5 bg-green-600 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-green-700 transition-colors mb-6 flex items-center justify-center gap-2">
                        <span>‚ûï</span> Incluir Novo CONSEG
                    </button>
                    
                    <div class="grid grid-cols-1 gap-4">
                        ${state.consegs.map(c => `
                            <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-2xl flex justify-between items-center border hover:shadow-md transition-shadow">
                                <div>
                                    <p class="font-black text-xl text-primary dark:text-blue-300">${c.nome} ${c.ativo ? '‚úÖ' : '‚ùå'}</p>
                                    <p class="text-xs text-gray-400 font-bold uppercase">${c.email || 'Sem e-mail'}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editConseg('${c.id}')" class="bg-amber-500 text-white p-4 rounded-xl shadow-md hover:scale-105 transition-transform">‚úèÔ∏è</button>
                                    <button onclick="deleteConseg('${c.id}')" class="bg-red-500 text-white p-4 rounded-xl shadow-md hover:scale-105 transition-transform">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPresident() {
            if (state.presidentView === 'login') {
                return `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 max-w-md mx-auto animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Acesso Presidente</h2>
                        <select id="pres-conseg" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                            <option value="">-- Escolha seu CONSEG --</option>
                            ${state.consegs.filter(c => c.ativo).map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                        </select>
                        <input type="password" id="pres-pass" placeholder="Senha do CONSEG" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                        <button onclick="handlePresidentLogin()" class="w-full p-5 bg-slate-700 text-white rounded-xl font-bold text-2xl shadow-lg hover:bg-slate-800 transition-colors">Entrar</button>
                        <button onclick="setScreen('home')" class="w-full p-4 text-gray-500 font-bold text-lg text-center block hover:text-gray-700">Voltar</button>
                    </div>
                `;
            }
            return renderPresidentDashboard();
        }

        function handlePresidentLogin() {
            const id = document.getElementById('pres-conseg').value;
            const pass = document.getElementById('pres-pass').value;
            if (!id) { alert("Selecione um CONSEG!"); return; }
            const c = state.consegs.find(con => String(con.id) === String(id));
            if (c && String(c.senha).trim() === String(pass).trim()) {
                state.currentUser = c;
                state.presidentView = 'dashboard';
                state.presidentAttempts = 0; 
                render();
            } else {
                state.presidentAttempts++;
                if (state.presidentAttempts >= 3) {
                    sendSecurityAlert();
                } else {
                    alert("Senha ou CONSEG incorretos!");
                }
            }
        }

        function renderPresidentDashboard() {
            const c = state.currentUser;
            if (!c) return `<p class='text-center'>Erro ao carregar dados.</p>`;

            return `
                <div class="space-y-8 animate-fade-in">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl space-y-6 border-t-8 border-primary">
                        <div class="flex justify-between items-center border-b pb-4">
                             <div>
                                <h2 class="text-3xl font-extrabold text-primary dark:text-blue-400">Meus Dados</h2>
                                <p class="font-bold text-gray-500 uppercase tracking-wide">${c.nome}</p>
                             </div>
                             <button onclick="state.presidentView = 'login'; state.currentUser = null; render();" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-600 transition-colors shadow">Sair do Painel</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block font-extrabold text-lg mb-2">E-mail do Presidente</label>
                                <input type="email" id="profile-email" value="${c.email || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:ring-2 ring-primary outline-none">
                            </div>
                            <div>
                                <label class="block font-extrabold text-lg mb-2">Senha do Painel (Livre)</label>
                                <input type="text" id="profile-pass" value="${c.senha || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:ring-2 ring-primary outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block font-extrabold text-lg mb-2">Agenda e Reuni√µes</label>
                                <textarea id="profile-agenda" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold min-h-[150px] focus:ring-2 ring-primary outline-none" style="white-space: pre-wrap;">${c.agenda || ''}</textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block font-extrabold text-lg mb-2">Status do CONSEG (Ativo no App)</label>
                                <select id="profile-ativo" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:ring-2 ring-primary outline-none">
                                    <option value="true" ${c.ativo ? 'selected' : ''}>Sim (Ativo)</option>
                                    <option value="false" ${!c.ativo ? 'selected' : ''}>N√£o (Inativo)</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="updateProfile()" class="w-full bg-green-600 text-white p-5 rounded-2xl font-bold text-2xl shadow-xl hover:bg-green-700 transition-colors">
                            üíæ Salvar Altera√ß√µes
                        </button>
                    </div>

                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-gray-600 transition-colors">Voltar ao In√≠cio</button>
                </div>
            `;
        }

        function renderAgenda() { 
            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in">
                    <h2 class="text-3xl font-bold text-purple-600 mb-6 flex items-center gap-2">üìÖ Agenda do CONSEG</h2>
                    <div class="space-y-4">
                        ${state.consegs.filter(c => c.ativo).map(c => `
                            <div class="p-6 bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-200 rounded-2xl flex flex-col gap-4">
                                <div>
                                    <h3 class="font-black text-xl text-purple-700 mb-2">${c.nome}</h3>
                                    <div class="text-lg font-bold text-gray-700 italic dark:text-gray-300" style="white-space: pre-wrap;">${c.agenda || 'Nenhuma agenda cadastrada.'}</div>
                                </div>
                                <button onclick="handleSendEmail('${c.id}')" class="w-full p-4 bg-purple-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-purple-700 transition-colors shadow-md">
                                    üìß Enviar E-mail ao Presidente
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-600 transition-colors">Voltar ao Menu</button>
                </div>
            `; 
        }

        function handleSendEmail(id) {
            const c = state.consegs.find(con => String(con.id) === String(id));
            if (!c) return;
            const email = (c.email && c.email.trim() !== '') ? c.email : 'ConsegComasaEspinheiros@Gmail.com';
            const subject = encodeURIComponent('Para o Presidente do CONSEG ' + c.nome);
            const body = encodeURIComponent('Ol√° Presidente do ' + c.nome + ',\n\nGostaria de tratar sobre o seguinte assunto:\n\n');
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        }

        function addNewConseg() {
            state.adminEditingConseg = { id: '', nome: '', email: '', senha: '', agenda: '', ativo: true };
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function editConseg(id) {
            const c = state.consegs.find(con => String(con.id) === String(id));
            if (c) {
                state.adminEditingConseg = { ...c };
                render();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function saveNewConseg() {
            const nomeVal = document.getElementById('edit-nome').value;
            const emailVal = document.getElementById('edit-email').value;
            const senhaVal = document.getElementById('edit-senha').value;
            const agendaVal = document.getElementById('edit-agenda').value;
            const ativoVal = document.getElementById('edit-ativo').value === 'true';
            if (!nomeVal) { alert("O Nome do CONSEG √© obrigat√≥rio!"); return; }
            const payload = { id: String(Date.now()), nome: nomeVal, email: emailVal, senha: String(senhaVal).trim(), agenda: agendaVal, ativo: ativoVal };
            state.loading = true; render();
            fetch(DIRECT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'save_conseg', payload }) })
            .then(() => {
                alert('Novo CONSEG cadastrado com sucesso!');
                state.adminEditingConseg = null;
                return fetchDataJSONP(true);
            }).then(() => render()).catch(() => { alert("Erro ao cadastrar."); state.loading = false; render(); });
        }

        function updateConsegData() {
            const edit = state.adminEditingConseg;
            const nomeVal = document.getElementById('edit-nome').value;
            const emailVal = document.getElementById('edit-email').value;
            const senhaVal = document.getElementById('edit-senha').value;
            const agendaVal = document.getElementById('edit-agenda').value;
            const ativoVal = document.getElementById('edit-ativo').value === 'true';
            const payload = { id: edit.id, nome: nomeVal, email: emailVal, senha: String(senhaVal).trim(), agenda: agendaVal, ativo: ativoVal };
            state.loading = true; render();
            fetch(DIRECT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'save_conseg', payload }) })
            .then(() => {
                alert('Dados do CONSEG atualizados!');
                state.adminEditingConseg = null;
                return fetchDataJSONP(true);
            }).then(() => render()).catch(() => { alert("Erro ao salvar."); state.loading = false; render(); });
        }

        function renderEmergencia() {
            const emergencyList = [
                { label: "Ligar para o 190 - Pol√≠cia Militar", val: "190", color: "bg-red-700" },
                { label: "Ligar para o 192 - SAMU", val: "192", color: "bg-red-600" },
                { label: "Ligar para o 193 - Corpo de Bombeiros", val: "193", color: "bg-orange-600" },
                { label: "Ligar para o 153 - Guarda Municipal", val: "153", color: "bg-blue-800" },
                { label: "Ligar para o 181 - Pol√≠cia Civil", val: "181", color: "bg-slate-700" },
                { label: "Ligar para o 115 - √Åguas de Joinville", val: "115", color: "bg-cyan-600" },
                { label: "Ligar para o 0800 48 0196 - CELESC", val: "0800480196", color: "bg-yellow-600" },
                { label: "Ligar para o 100 - Denunciar viol√™ncia contra CRIAN√áAS, ADOLESCENTES e IDOSOS", val: "100", color: "bg-purple-600" },
                { label: "Ligar para o 180 - Denunciar viol√™ncia contra a MULHER", val: "180", color: "bg-purple-600" },
                { label: "Ligar para o 188 - Preven√ß√£o ao suic√≠dio ‚Äì CVV", val: "188", color: "bg-teal-600" }
            ];

            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-4 animate-fade-in">
                    <h2 class="text-3xl font-bold text-red-600 mb-6 flex items-center gap-2">üö® EMERG√äNCIA</h2>
                    ${emergencyList.map(item => `
                        <button onclick="window.open('tel:${item.val}')" class="w-full p-6 ${item.color} text-white rounded-2xl flex justify-between items-center font-bold text-xl text-left hover:opacity-90 transition-all shadow-md active:scale-95">
                            <span>${item.label}</span>
                            <span>üìû</span>
                        </button>
                    `).join('')}
                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-lg mt-6 shadow-lg">Voltar ao Menu</button>
                </div>
            `;
        }

        function renderServicos() {
             const servicesList = [
                { label: "Ligar para o 3441.0400 - Agendar recolhimento de m√≥veis, animais mortos, etc.", val: "34410400", color: "bg-emerald-600" },
                { label: "Ligar para o 3027.7115 - DISK COLETA para GRANDES QUANTIDADES: Computadores, lixo eletr√¥nico e √≥leo de cozinha", val: "30277115", color: "bg-cyan-700" },
                { label: "Ligar para o 3431.3233 - Prefeitura de Joinville", val: "34313233", color: "bg-slate-600" }
            ];
            
            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-4 animate-fade-in">
                    <h2 class="text-3xl font-bold text-teal-600 mb-6">üõ†Ô∏è SERVI√áOS</h2>
                    ${servicesList.map(item => `
                        <button onclick="window.open('tel:${item.val}')" class="w-full p-6 ${item.color} text-white rounded-2xl flex justify-between items-center font-bold text-xl text-left hover:opacity-90 transition-all shadow-md active:scale-95">
                            <span>${item.label}</span>
                            <span>üìû</span>
                        </button>
                    `).join('')}
                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-lg mt-6 shadow-lg">Voltar ao Menu</button>
                </div>
            `;
        }

        function isOuvidoriaValid() {
            const name = state.ouvidoriaUser || '';
            const pass = state.ouvidoriaPass || '';
            return name.trim().length > 0 && /^[A-Z]{3}-[0-9]{6}$/.test(pass);
        }

        function updateOuvidoriaButtons() {
            const container = document.getElementById('ouvidoria-actions');
            if (!container) return;
            
            if (isOuvidoriaValid()) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="handleOuvidoriaLogin('list')" class="bg-blue-600 text-white p-5 rounded-xl font-bold shadow-lg transition-all active:scale-95">Buscar Registros</button>
                        <button onclick="handleOuvidoriaLogin('form')" class="bg-green-600 text-white p-5 rounded-xl font-bold shadow-lg transition-all active:scale-95">Novo Registro</button>
                        <button onclick="setScreen('home')" class="bg-gray-500 text-white p-5 rounded-xl font-bold">Voltar</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <p class="text-center font-bold text-gray-500 py-4 animate-fade-in">Informe seu nome e senha para buscar ou incluir registros.</p>
                    <button onclick="setScreen('home')" class="bg-gray-500 text-white p-5 rounded-xl font-bold w-full">Voltar</button>
                `;
            }
        }
        
        function renderOuvidoria() { 
            if (state.ouvidoriaView === 'login') { 
                const valid = isOuvidoriaValid();
                return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl space-y-6 max-w-md mx-auto animate-fade-in">
                    <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Minha Ouvidoria</h2>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Meu primeiro NOME</label>
                        <input type='text' id='ouv-nome' value="${state.ouvidoriaUser || ''}" oninput='this.value = this.value.toUpperCase().substring(0,15); state.ouvidoriaUser = this.value; updateOuvidoriaButtons();' class='w-full p-4 border rounded-xl font-bold' placeholder='Seu primeiro nome' required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase">Sua senha neste APP</label>
                        <input type="text" id="ouv-pass" value="${state.ouvidoriaPass || ''}" oninput="let v = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); if (v.length > 3) { v = v.substring(0,3) + '-' + v.substring(3,9); } this.value = v; state.ouvidoriaPass = v; updateOuvidoriaButtons();" maxlength="10" placeholder="ABC-123456" class="w-full p-4 border rounded-xl font-bold" required>
                    </div>
                    <div id="ouvidoria-actions">
                        ${valid ? `
                            <div class="grid grid-cols-1 gap-4">
                                <button onclick="handleOuvidoriaLogin('list')" class="bg-blue-600 text-white p-5 rounded-xl font-bold shadow-lg transition-all active:scale-95">Buscar Registros</button>
                                <button onclick="handleOuvidoriaLogin('form')" class="bg-green-600 text-white p-5 rounded-xl font-bold shadow-lg transition-all active:scale-95">Novo Registro</button>
                                <button onclick="setScreen('home')" class="bg-gray-500 text-white p-5 rounded-xl font-bold">Voltar</button>
                            </div>
                        ` : `
                            <p class="text-center font-bold text-gray-500 py-4">Informe seu nome e senha para buscar ou incluir registros.</p>
                            <button onclick="setScreen('home')" class="bg-gray-500 text-white p-5 rounded-xl font-bold w-full">Voltar</button>
                        `}
                    </div>
                </div>`; 
            } 

            if (state.ouvidoriaView === 'list') {
                const valid = isOuvidoriaValid();
                
                // Filtragem Global antes de Renderizar (Garante compatibilidade com min√∫sculas r.username)
                let filtered = state.registrations.filter(r => 
                    String(r.userName || '').toUpperCase() === String(state.ouvidoriaUser || '').toUpperCase() && 
                    String(r.userPassword || '').toUpperCase() === String(state.ouvidoriaPass || '').toUpperCase()
                );

                // Aplica√ß√£o dos Filtros de Busca Avan√ßada
                if (state.filterStatus && state.filterStatus !== 'Todos') {
                    filtered = filtered.filter(r => r.status === state.filterStatus);
                }
                if (state.filterPeriodStart) {
                    filtered = filtered.filter(r => new Date(r.createdAt) >= new Date(state.filterPeriodStart));
                }
                if (state.filterPeriodEnd) {
                    const endDate = new Date(state.filterPeriodEnd);
                    endDate.setHours(23, 59, 59);
                    filtered = filtered.filter(r => new Date(r.createdAt) <= endDate);
                }

                // Ordena√ß√£o: Registro mais recente no topo (Sort Descendente)
                filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                window.ultimosRegistros = filtered;

                return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-400 mb-2 uppercase text-center">Meus Registros</h2>
                    
                    <!-- Filtros de Busca (Interface Pequena e Discreta) -->
                    <div class="flex flex-wrap items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200">
                        <select id="filter-status" onchange="state.filterStatus = this.value; render();" class="text-[10px] p-1 border rounded bg-white dark:bg-gray-600 font-bold outline-none">
                            <option value="Todos" ${state.filterStatus === 'Todos' ? 'selected' : ''}>Status: Todos</option>
                            <option value="Aberto" ${state.filterStatus === 'Aberto' ? 'selected' : ''}>Aberto</option>
                            <option value="Em andamento" ${state.filterStatus === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                            <option value="Solucionado" ${state.filterStatus === 'Solucionado' ? 'selected' : ''}>Solucionado</option>
                            <option value="Fechado" ${state.filterStatus === 'Fechado' ? 'selected' : ''}>Fechado</option>
                        </select>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] font-bold text-gray-400 uppercase">De:</span>
                            <input type="date" id="filter-date-start" value="${state.filterPeriodStart}" onchange="state.filterPeriodStart = this.value; render();" class="text-[10px] p-1 border rounded bg-white dark:bg-gray-600 outline-none">
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] font-bold text-gray-400 uppercase">At√©:</span>
                            <input type="date" id="filter-date-end" value="${state.filterPeriodEnd}" onchange="state.filterPeriodEnd = this.value; render();" class="text-[10px] p-1 border rounded bg-white dark:bg-gray-600 outline-none">
                        </div>
                    </div>

                    <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                        ${filtered.length === 0 ? '<p class="text-center py-10 font-bold text-gray-500">Nenhum registro encontrado.</p>' : filtered.map(r => `
                            <div class="p-5 bg-gray-50 dark:bg-gray-700 rounded-2xl border-l-8 ${getStatusBorderClass(r.status)} shadow-sm relative group">
                                <div class="flex flex-col gap-1 pr-16">
                                    <p class="font-bold text-gray-800 dark:text-gray-100 text-xl">${r.subject}</p>
                                    ${r.processNumber ? `<p class="text-sm font-black text-primary">Proc: ${r.processNumber}</p>` : ''}
                                    <div class="text-[10px] flex gap-4 text-gray-500">
                                        <span>CONSEG: ${state.consegs.find(c => c.id === r.consegId)?.nome || 'S/ Ref'}</span>
                                        ${r.processDate ? `<span>Data Proc: ${new Date(r.processDate).toLocaleDateString()}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t mt-3 text-[10px] text-gray-400 italic">
                                    <span>üìÖ Registro: ${new Date(r.createdAt).toLocaleString()}</span>
                                    <span class="font-black uppercase text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${r.status}</span>
                                </div>
                                ${valid ? `
                                <div class="absolute top-4 right-4 flex flex-col gap-2">
                                    <button onclick="window.abrirEdicaoOuvidoria('${r.id}')" class="bg-blue-500 text-white p-4 rounded-xl shadow hover:bg-blue-600 transition-colors" title="Ajustar Registro">‚úèÔ∏è</button>
                                    <button onclick="handleDeleteOuvidoria('${r.id}')" class="bg-red-500 text-white p-4 rounded-xl shadow hover:bg-red-600 transition-colors" title="Excluir">üóëÔ∏è</button>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ${valid ? `
                        <button onclick="state.ouvidoriaView = 'form'; state.ouvidoriaEditingId = null; registroParaEditar = null; resetOuvidoriaForm(); render();" class="w-full p-5 bg-blue-600 text-white rounded-xl font-bold shadow-lg uppercase transition-transform active:scale-95">
                            + Incluir Novo Registro
                        </button>
                    ` : ''}
                    <button onclick="state.ouvidoriaView = 'login'; render();" class="w-full p-4 bg-gray-500 text-white rounded-xl font-bold">Voltar</button>
                </div>`;
            }

            if (state.ouvidoriaView === 'form') {
                 const isEdit = registroParaEditar !== null;
                 return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-400 uppercase text-center">${isEdit ? '‚úèÔ∏è Editar Registro' : '‚ûï Novo Registro'}</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">CONSEG Destino</label>
                            <select id="form-conseg" class="w-full p-4 border rounded-xl font-bold dark:bg-gray-700">
                                <option value="">-- Selecione o CONSEG --</option>
                                ${state.consegs.filter(c => c.ativo).map(c => `<option value="${c.id}" ${registroParaEditar && c.id === registroParaEditar.consegId ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">N√∫mero do Processo</label>
                            <input type="text" id="reg-processNumber" maxlength="13" value="${registroParaEditar ? registroParaEditar.processNumber : ''}"
                                oninput="let v = this.value.replace(/\\D/g, '').substring(0,10); let r = ''; if (v.length > 0) r += v.slice(0, 2); if (v.length > 2) r += '.' + v.slice(2, 3); if (v.length > 3) r += '.' + v.slice(3, 9); if (v.length > 9) r += '-' + v.slice(9, 10); this.value = r; document.getElementById('reg-date-container').style.display = v.length > 0 ? 'block' : 'none';" 
                                placeholder="99.9.999999-9" class="w-full p-4 border rounded-xl font-bold dark:bg-gray-700">
                        </div>
                        <div id="reg-date-container" style="display: ${registroParaEditar && registroParaEditar.processNumber ? 'block' : 'none'};">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Data do Processo</label>
                            <input type="date" id="reg-processDate" value="${registroParaEditar ? registroParaEditar.processDate : ''}" class="w-full p-4 border rounded-xl font-bold dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Status</label>
                            <select id="reg-status" class="w-full p-4 border rounded-xl font-bold dark:bg-gray-700">
                                <option value="Aberto" ${registroParaEditar && registroParaEditar.status === 'Aberto' ? 'selected' : ''}>Aberto</option>
                                <option value="Em andamento" ${registroParaEditar && registroParaEditar.status === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                                <option value="Solucionado" ${registroParaEditar && registroParaEditar.status === 'Solucionado' ? 'selected' : ''}>Solucionado</option>
                                <option value="Fechado" ${registroParaEditar && registroParaEditar.status === 'Fechado' ? 'selected' : ''}>Fechado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Assunto / Descri√ß√£o</label>
                            <textarea id="form-subject" placeholder="Descreva o que aconteceu..." class="w-full p-4 border rounded-xl font-bold dark:bg-gray-700 h-32">${registroParaEditar ? registroParaEditar.subject : ''}</textarea>
                        </div>
                        <button onclick="handleSaveNewRegistration(event)" class="w-full p-5 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg transition-transform active:scale-95">Salvar Registro</button>
                        <button onclick="state.ouvidoriaView = 'list'; registroParaEditar = null; state.ouvidoriaEditingId = null; render();" class="w-full p-4 bg-gray-500 text-white rounded-xl font-bold">Cancelar</button>
                    </div>
                </div>`;
            }
        }

        function resetOuvidoriaForm() {
            state.formConsegId = '';
            state.formSubject = '';
            state.formProcessNumber = '';
            state.formProcessDate = '';
            state.formStatus = 'Aberto';
        }

        async function handleDeleteOuvidoria(id) {
            if (!confirm("Tem certeza que deseja excluir este registro permanentemente?")) return;
            
            state.loading = true; render();
            try {
                await fetch(DIRECT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: 'delete_registration', payload: { id } })
                });
                alert("Registro exclu√≠do com sucesso!");
                await fetchDataJSONP(true);
            } catch (e) {
                alert("Erro ao excluir registro.");
                state.loading = false;
                render();
            }
        }

        async function handleSaveNewRegistration(event) {
            if (event) event.preventDefault(); // Bloqueio do Refresh

            const consegId = document.getElementById('form-conseg').value;
            const subject = document.getElementById('form-subject').value;
            const processNumber = document.getElementById('reg-processNumber').value;
            const processDate = document.getElementById('reg-processDate').value;
            const status = document.getElementById('reg-status').value;
            
            if (!consegId || !subject) {
                alert("Preencha todos os campos obrigat√≥rios (CONSEG e Assunto)!");
                return;
            }

            // Identifica√ß√£o da Opera√ß√£o (update_registration para edi√ß√µes)
            const isUpdate = registroParaEditar !== null;
            const finalId = isUpdate ? registroParaEditar.id : String(Date.now());

            const payload = {
                id: finalId, // Garante envio do ID original no update
                userName: state.ouvidoriaUser,
                userPassword: state.ouvidoriaPass,
                consegId: consegId,
                subject: subject,
                processNumber: processNumber,
                processDate: processDate,
                status: status,
                createdAt: isUpdate ? registroParaEditar.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                latitude: "", // Removido definitivamente GPS
                longitude: ""
            };

            // --- ATUALIZA√á√ÉO OTIMISTA (INSTANT√ÇNEA NA MEM√ìRIA) ---
            if (isUpdate) {
                const idx = state.registrations.findIndex(r => String(r.id) === String(finalId));
                if (idx !== -1) {
                    state.registrations[idx] = { ...payload };
                }
            } else {
                state.registrations.unshift(payload);
            }

            // MUDAN√áA DE TELA E RENDERIZA√á√ÉO IMEDIATA
            state.ouvidoriaView = 'list';
            registroParaEditar = null;
            state.ouvidoriaEditingId = null;
            resetOuvidoriaForm();
            render(); // A lista reflete a mudan√ßa no exato momento do clique

            // --- SINCRONIZA√á√ÉO EM BACKGROUND (SEGUNDO PLANO) ---
            const type = isUpdate ? 'update_registration' : 'registration';
            fetch(DIRECT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ type: type, payload: payload }) 
            })
            .then(() => {
                // Sincroniza√ß√£o silenciosa opcional para garantir ordem/ids definitivos
                fetchDataJSONP(true); 
            })
            .catch((err) => {
                console.error("Erro no salvamento em background:", err);
                alert("Erro ao gravar dados na nuvem. Verifique sua internet.");
            });
        }

        function handleOuvidoriaLogin(view) { if (isOuvidoriaValid()) { state.ouvidoriaView = view; render(); fetchDataJSONP(); } }

        function renderAdminRegistros() {
            const filtered = state.registrations.sort((a,b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            if (filtered.length === 0) return `<p class="text-center py-10 font-bold text-gray-500">Nenhum registro encontrado no sistema.</p>`;
            return `<div class="grid grid-cols-1 gap-4 animate-fade-in">${filtered.map(r => `<div class="bg-white dark:bg-gray-700 p-5 rounded-2xl border-l-8 ${getStatusBorderClass(r.status)} shadow-md transition-all duration-300"><p class="font-extrabold text-lg text-primary dark:text-blue-400">Proc: ${r.processNumber || 'S/ N¬∫'}</p><p class="font-extrabold text-gray-800 dark:text-gray-100">${r.userName}</p><p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">${r.subject}</p><div class="flex justify-between items-center pt-3 border-t text-[10px] text-gray-400 italic"><span>üìÖ ${new Date(r.createdAt).toLocaleDateString()}</span><span>üîÑ ${new Date(r.updatedAt || r.createdAt).toLocaleDateString()}</span></div></div>`).join('')}</div>`;
        }

        function getStatusBorderClass(status) { if (status === 'Pendente' || status === 'Aberto') return 'status-border-pendente'; if (status === 'Em andamento' || status === 'Em Andamento') return 'status-border-andamento'; if (status === 'Conclu√≠do' || status === 'Solucionado' || status === 'Fechado') return 'status-border-concluido'; return 'border-gray-300'; }

        // INICIALIZA√á√ÉO
        setInterval(() => { state.currentTime = new Date(); if (state.screen === 'home') render(); }, 60000);
        setInterval(() => fetchDataJSONP(), 120000);
        fetchAppVersion();
        fetchDataJSONP(); render();

        // --- FUN√á√ÉO EDITAR ISOLADA E GLOBAL PARA MOBILE ---
        window.abrirEdicaoOuvidoria = function(id) {
          const reg = window.ultimosRegistros.find(r => String(r.id) === String(id));
          if (!reg) return;
          registroParaEditar = reg; 
          
          state.ouvidoriaView = 'form';
          state.ouvidoriaEditingId = id; 
          render();

          let tentativas = 0;
          const checkExist = setInterval(function() {
            const campoAssunto = document.getElementById('form-subject');
            if (campoAssunto) {
              campoAssunto.value = reg.subject || '';
              const procNum = document.getElementById('reg-processNumber');
              const procDate = document.getElementById('reg-processDate');
              const statusField = document.getElementById('reg-status');
              const consegField = document.getElementById('form-conseg');

              if (procNum) procNum.value = reg.processNumber || '';
              if (procDate) procDate.value = reg.processDate || '';
              if (statusField) statusField.value = reg.status || 'Aberto';
              if (consegField) consegField.value = reg.consegId || '';
              
              if(reg.processNumber) {
                  const container = document.getElementById('reg-date-container');
                  if (container) container.style.display = 'block';
              }
              
              clearInterval(checkExist);
            }
            if (++tentativas > 20) clearInterval(checkExist);
          }, 100);
        };
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>