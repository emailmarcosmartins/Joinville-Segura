<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joinville Segura</title>
    <!-- Tailwind CSS para o visual moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .elderly-text { font-size: 1.25rem; line-height: 1.75rem; font-weight: 700; }
        input, select, textarea { font-size: 1.25rem !important; font-weight: 600 !important; }
        button { transition: all 0.2s; }
        button:active { transform: scale(0.95); }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos de borda por status */
        .status-border-pendente { border-left-color: #ef4444 !important; } /* Vermelho */
        .status-border-andamento { border-left-color: #f59e0b !important; } /* Amarelo */
        .status-border-concluido { border-left-color: #10b981 !important; } /* Verde */
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "lucide-react": "https://esm.sh/lucide-react@^0.564.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200 min-h-screen">

    <div id="root" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- O conte√∫do ser√° injetado via React/DOM -->
    </div>

    <script>
        // --- T√âCNICA JSONP GLOBAL ---
        window.lastData = null;
        window.handleGoogleData = function(data) {
            let parsedData = data;
            if (typeof data === 'string') {
                try {
                    parsedData = JSON.parse(data);
                } catch (e) {
                    console.error("Erro ao processar JSON da string recebida:", e);
                }
            }
            window.lastData = parsedData;
        };

        // --- CONFIGURA√á√ïES E CONSTANTES ---
        const DIRECT_URL = 'https://script.google.com/macros/s/AKfycbzn2NSn77z4nsNOyDSyfT5_YKBLimBdN4X1oVa0MSxJbpqIjFrCuJ4rwhpiRSyBrE1l/exec';
        const ADMIN_PASSWORD_LOCAL = '30012026';

        // --- ESTADO GLOBAL DO APLICATIVO ---
        let state = {
            screen: 'home',
            darkMode: false,
            currentTime: new Date(),
            registrations: [],
            consegs: [],
            loading: false,
            isAdminAuthenticated: false,
            adminTab: 'registros',
            adminEditingConseg: null,
            filterPeriodStart: '',
            filterPeriodEnd: '',
            filterStatus: '',
            filterConseg: '',
            ouvidoriaUser: '',
            ouvidoriaPass: '',
            ouvidoriaEditingId: null,
            ouvidoriaView: 'login',
            presidentView: 'login', // login, dashboard
            currentUser: null,
            formSubject: '',
            formConsegId: '',
            formProcessNumber: '',
            formProcessDate: '',
            formStatus: 'Pendente',
            ouvidoriaListFilterStatus: ''
        };

        // --- UTILIT√ÅRIOS ---
        const maskName = (val) => val.toUpperCase().substring(0, 15);
        const maskUserPassword = (val) => {
            const cleaned = val.replace(/[^A-Za-z0-9]/g, '');
            const letters = cleaned.slice(0, 3).replace(/[^A-Za-z]/g, '').toUpperCase();
            const digits = cleaned.slice(3, 9).replace(/[^0-9]/g, '');
            let res = letters;
            if (letters.length >= 3) res = letters.slice(0, 3) + '-' + digits.slice(0, 6);
            return res.substring(0, 10);
        };
        const maskProcessNumber = (val) => {
            const digits = val.replace(/[^0-9]/g, '').slice(0, 10);
            let res = '';
            if (digits.length > 0) res += digits.slice(0, 2);
            if (digits.length > 2) res += '.' + digits.slice(2, 3);
            if (digits.length > 3) res += '.' + digits.slice(3, 9);
            if (digits.length > 9) res += '-' + digits.slice(9, 10);
            return res;
        };
        const getOS = () => {
            const ua = navigator.userAgent;
            if (/android/i.test(ua)) return 'Android';
            if (/iPad|iPhone|iPod/.test(ua)) return 'iOS';
            return 'Web';
        };

        // --- COMUNICA√á√ÉO JSONP COM POLLING ---
        let dataPollingInterval = null;

        function fetchDataJSONP(force = false) {
            if (!force && (state.ouvidoriaView === 'form' || state.adminEditingConseg || (state.screen === 'president' && state.presidentView === 'dashboard'))) {
                return;
            }

            state.loading = true;
            window.lastData = null; 
            render();

            const oldScript = document.getElementById('google-script-loader');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'google-script-loader';
            script.src = `${DIRECT_URL}?callback=handleGoogleData&t=${Date.now()}`;
            document.body.appendChild(script);

            const startTime = Date.now();
            if (dataPollingInterval) clearInterval(dataPollingInterval);

            dataPollingInterval = setInterval(() => {
                if (window.lastData) {
                    processIncomingData(window.lastData);
                    clearInterval(dataPollingInterval);
                    state.loading = false;
                    render();
                }
                if (Date.now() - startTime > 20000) {
                    clearInterval(dataPollingInterval);
                    state.loading = false;
                    render();
                }
            }, 500);
        }

        function processIncomingData(data) {
            if (data && data.consegs) {
                state.consegs = data.consegs.map(c => ({
                    id: c.id || '',
                    nome: c.nome || '',
                    senha: c.senha || '',
                    ativo: String(c.ativo).toLowerCase() === 'true',
                    email: c.email || '',
                    agenda: c.agenda || ''
                }));
                if (state.currentUser) {
                   const updated = state.consegs.find(c => String(c.id) === String(state.currentUser.id));
                   if (updated) state.currentUser = updated;
                }
            }

            if (data && data.registrations) {
                state.registrations = data.registrations.map(r => ({
                    id: r.id || '',
                    userName: r.username || r.userName || '',
                    userPassword: r.userpassword || r.userPassword || '',
                    consegId: r.consegid || r.consegId || '',
                    subject: r.subject || '',
                    processNumber: r.processnumber || r.processNumber || '',
                    processDate: r.processdate || r.processDate || '',
                    status: r.status || 'Pendente',
                    createdAt: r.createdat || r.createdAt || new Date().toISOString(),
                    updatedAt: r.updatedat || r.updatedAt || r.createdat || r.createdAt || new Date().toISOString(),
                    latitude: r.latitude || null,
                    longitude: r.longitude || null
                }));
            }
        }

        function setScreen(scr) {
            state.screen = scr;
            state.adminEditingConseg = null;
            render();
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.documentElement.classList.toggle('dark', state.darkMode);
            render();
        }

        function render() {
            const root = document.getElementById('root');
            const dateStr = state.currentTime.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = state.currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            let content = `
                <header class="text-center mb-8 animate-fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <div class="w-10"></div>
                        <h1 class="text-3xl md:text-5xl font-extrabold text-primary dark:text-blue-400">Joinville Segura</h1>
                        <button onclick="toggleDarkMode()" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700">
                            ${state.darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                    <p class="text-xl md:text-2xl font-bold text-gray-700 dark:text-gray-300 text-center">Sistema Comunit√°rio de Seguran√ßa P√∫blica</p>
                    <p class="text-lg font-bold text-gray-500 mt-2 text-center">${formattedDate} ${timeStr}</p>
                </header>
                
                <main id="app-main">
                    ${renderScreen()}
                </main>

                ${state.screen === 'home' ? renderFooter() : ''}
            `;

            root.innerHTML = content;
        }

        function renderScreen() {
            switch(state.screen) {
                case 'home': return renderHome();
                case 'ouvidoria': return renderOuvidoria();
                case 'emergencia': return renderEmergencia();
                case 'servicos': return renderServicos();
                case 'agenda': return renderAgenda();
                case 'admin': return renderAdmin();
                case 'president': return renderPresident();
                default: return renderHome();
            }
        }

        function renderHome() {
            const buttons = [
                { label: "Abrir OUVIDORIA na Prefeitura de Joinville (App Joinville F√°cil)", color: "bg-blue-600", icon: "üè¢", click: "window.open('https://oauthexternal.joinville.sc.gov.br/')" },
                { label: "Registrar no CONSEG a OUVIDORIA da Prefeitura de Joinville", color: "bg-indigo-600", icon: "üìù", click: "setScreen('ouvidoria')" },
                { label: "Acessar o APP PMSC Cidad√£o da Pol√≠cia Militar", color: "bg-emerald-600", icon: "üëÆ", click: "handlePMSCCidadao()" },
                { label: "Registrar Boletim de Ocorr√™ncia (B.O.) na Pol√≠cia Civil", color: "bg-red-600", icon: "üìë", click: "window.open('https://delegaciavirtual.sc.gov.br/')" },
                { label: "SINESP Cidad√£o (Consultar ve√≠culo pela placa)", color: "bg-yellow-600", icon: "üöó", click: "handleSinesp()" },
                { label: "CELESC (Energia El√©trica)", color: "bg-orange-600", icon: "‚ö°", click: "handleCelesc()" },
                { label: "Telefones de EMERG√äNCIA", color: "bg-rose-600", icon: "üö®", click: "setScreen('emergencia')" },
                { label: "Telefones de SERVI√áOS", color: "bg-teal-600", icon: "üõ†Ô∏è", click: "setScreen('servicos')" },
                { label: "Agenda do CONSEG", color: "bg-purple-600", icon: "üìÖ", click: "setScreen('agenda')" },
                { label: "Intelig√™ncia Artificial ChatGPT", color: "bg-cyan-600", icon: "ü§ñ", click: "window.open('https://chatgpt.com/')" }
            ];

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                    ${buttons.map(b => `
                        <button onclick="${b.click}" class="${b.color} text-white p-6 rounded-2xl shadow-xl flex items-center gap-4 text-left elderly-text min-h-[110px] hover:scale-[1.02] transition-transform">
                            <span class="text-4xl bg-white/20 p-2 rounded-xl">${b.icon}</span>
                            <span>${b.label}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="mt-12 bg-gray-100 dark:bg-gray-800 p-6 rounded-3xl border-2 border-dashed border-gray-400">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2 text-primary dark:text-blue-400">üõ°Ô∏è √Årea Administrativa</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button onclick="setScreen('president')" class="bg-slate-700 text-white p-4 rounded-xl font-bold">Presidente de CONSEG</button>
                        <button onclick="setScreen('admin')" class="bg-slate-700 text-white p-4 rounded-xl font-bold">Painel Admin</button>
                        <button onclick="window.close()" class="bg-red-900 text-white p-4 rounded-xl font-bold">Sair do Aplicativo</button>
                    </div>
                </div>
                <footer class="mt-8 pt-8 border-t text-center space-y-6">
                    <p class="text-lg font-bold text-gray-600 dark:text-gray-400">Este aplicativo "Joinville Segura" foi idealizado por Marcos Roberto Martins - Membro do Conselho Comunit√°rio de Seguran√ßa CONSEG Comasa e Espinheiros desde 2017.</p>
                </footer>
            `;
        }

        function renderAdmin() {
            if (!state.isAdminAuthenticated) {
                return `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 max-w-md mx-auto animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Painel Administrativo</h2>
                        <input type="password" id="admin-pass" placeholder="Senha do Sistema" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold text-2xl">
                        <button onclick="handleAdminLogin()" class="w-full p-5 bg-slate-700 text-white rounded-xl font-bold text-2xl shadow-lg">Entrar</button>
                        <button onclick="setScreen('home')" class="w-full p-4 text-gray-500 font-bold text-lg">Voltar √† Home</button>
                    </div>
                `;
            }

            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center border-b pb-4">
                        <h2 class="text-3xl font-extrabold text-primary dark:text-blue-400">Painel Administrativo</h2>
                        <button onclick="state.isAdminAuthenticated = false; render();" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold">Sair</button>
                    </div>
                    <div class="flex bg-gray-100 dark:bg-gray-700 p-2 rounded-2xl gap-2">
                        <button onclick="state.adminTab = 'registros'; render();" class="flex-1 p-4 rounded-xl font-bold ${state.adminTab === 'registros' ? 'bg-white shadow text-primary' : 'text-gray-500'}">üìã Registros</button>
                        <button onclick="state.adminTab = 'consegs'; render();" class="flex-1 p-4 rounded-xl font-bold ${state.adminTab === 'consegs' ? 'bg-white shadow text-primary' : 'text-gray-500'}">üõ°Ô∏è CONSEGs</button>
                    </div>
                    ${state.adminTab === 'registros' ? renderAdminRegistros() : renderAdminConsegs()}
                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-xl">Voltar ao Menu</button>
                </div>
            `;
        }

        function getStatusBorderClass(status) {
            if (status === 'Pendente') return 'status-border-pendente';
            if (status === 'Em Andamento') return 'status-border-andamento';
            if (status === 'Conclu√≠do') return 'status-border-concluido';
            return 'border-gray-300';
        }

        function renderAdminRegistros() {
            const filtered = state.registrations.sort((a,b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            if (filtered.length === 0) return `<p class="text-center py-10 font-bold text-gray-500">Nenhum registro encontrado.</p>`;

            return `
                <div class="grid grid-cols-1 gap-4 animate-fade-in">
                    ${filtered.map(r => `
                        <div id="card-${r.id}" class="bg-white dark:bg-gray-700 p-5 rounded-2xl shadow-md border-l-8 ${getStatusBorderClass(r.status)} transition-all duration-300">
                            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-primary dark:text-blue-400">üìã</span>
                                    <span class="font-extrabold text-lg text-primary dark:text-blue-300">Proc: ${r.processNumber || 'S/ N¬∫'}</span>
                                </div>
                                <div class="w-full sm:w-auto">
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Alterar Status</label>
                                    <select 
                                        onchange="updateRegStatus('${r.id}', this.value)" 
                                        class="w-full sm:w-40 p-2 text-xs font-bold rounded-lg border-2 dark:bg-gray-600 outline-none focus:border-primary transition-colors bg-gray-50 dark:border-gray-500"
                                    >
                                        <option value="Pendente" ${r.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="Em Andamento" ${r.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="Conclu√≠do" ${r.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-1 mb-4">
                                <p class="font-extrabold text-gray-800 dark:text-gray-100">${r.userName}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">${r.subject}</p>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-600">
                                <div class="flex gap-3 text-[10px] text-gray-400 font-semibold italic">
                                    <span>üìÖ Criado: ${new Date(r.createdAt).toLocaleDateString()}</span>
                                    <span>üîÑ Alt: ${new Date(r.updatedAt || r.createdAt).toLocaleDateString()}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="r.latitude && window.open('https://www.google.com/maps?q=' + r.latitude + ',' + r.longitude)" class="text-blue-500 hover:scale-110 transition-transform">üìç</button>
                                    <button onclick="deleteReg('${r.id}')" class="text-red-500 hover:scale-110 transition-transform">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAdminConsegs() {
             return `<div class="space-y-4">${state.consegs.map(c => `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl flex justify-between items-center border"><div><p class="font-extrabold text-lg">${c.nome}</p></div><div class="flex gap-2"><button onclick="editConseg('${c.id}')" class="bg-amber-500 text-white p-3 rounded-xl shadow">‚úèÔ∏è</button><button onclick="deleteConseg('${c.id}')" class="bg-red-500 text-white p-3 rounded-xl shadow">üóëÔ∏è</button></div></div>`).join('')}</div>`;
        }

        function handleAdminLogin() {
            if (document.getElementById('admin-pass').value === ADMIN_PASSWORD_LOCAL) { state.isAdminAuthenticated = true; render(); fetchDataJSONP(); }
            else alert('Senha Incorreta!');
        }

        // --- PRESIDENTE ---
        function renderPresident() {
            if (state.presidentView === 'login') {
                return `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 max-w-md mx-auto animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Acesso Presidente</h2>
                        <select id="pres-conseg" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                            <option value="">-- Escolha seu CONSEG --</option>
                            ${state.consegs.filter(c => c.ativo).map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                        </select>
                        <input type="password" id="pres-pass" placeholder="Senha do CONSEG" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                        <button onclick="handlePresidentLogin()" class="w-full p-5 bg-slate-700 text-white rounded-xl font-bold text-2xl shadow-lg">Entrar</button>
                        <button onclick="setScreen('home')" class="w-full p-4 text-gray-500 font-bold text-lg text-center block">Voltar</button>
                    </div>
                `;
            }
            return renderPresidentDashboard();
        }

        function handlePresidentLogin() {
            const id = document.getElementById('pres-conseg').value;
            const pass = document.getElementById('pres-pass').value;
            if (!id) { alert("Selecione um CONSEG!"); return; }
            const c = state.consegs.find(con => String(con.id) === String(id));
            if (c && String(c.senha).trim() === String(pass).trim()) {
                state.currentUser = c;
                state.presidentView = 'dashboard';
                render();
            } else alert("Senha ou CONSEG incorretos!");
        }

        function renderPresidentDashboard() {
            const c = state.currentUser;
            if (!c) return `<p class='text-center'>Erro ao carregar dados.</p>`;

            return `
                <div class="space-y-8 animate-fade-in">
                    <!-- FORMUL√ÅRIO DE EDI√á√ÉO DE PERFIL -->
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl space-y-6 border-t-8 border-primary">
                        <div class="flex justify-between items-center border-b pb-4">
                             <div>
                                <h2 class="text-3xl font-extrabold text-primary dark:text-blue-400">Meus Dados</h2>
                                <p class="font-bold text-gray-500">${c.nome}</p>
                             </div>
                             <button onclick="state.presidentView = 'login'; state.currentUser = null; render();" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold">Sair do Painel</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block font-extrabold text-lg mb-2">E-mail do Presidente</label>
                                <input type="email" id="profile-email" value="${c.email || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:ring-2 ring-primary outline-none">
                            </div>
                            <div>
                                <label class="block font-extrabold text-lg mb-2">Senha do Painel (Livre)</label>
                                <input type="text" id="profile-pass" value="${c.senha || ''}" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold focus:ring-2 ring-primary outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block font-extrabold text-lg mb-2">Agenda e Reuni√µes</label>
                                <textarea id="profile-agenda" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold min-h-[150px] focus:ring-2 ring-primary outline-none">${c.agenda || ''}</textarea>
                            </div>
                        </div>
                        <button onclick="updateProfile()" class="w-full bg-green-600 text-white p-5 rounded-2xl font-bold text-2xl shadow-xl hover:bg-green-700 transition-colors">
                            üíæ Salvar Altera√ß√µes
                        </button>
                    </div>

                    <button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold text-xl">Voltar ao In√≠cio</button>
                </div>
            `;
        }

        async function updateProfile() {
            const emailInput = document.getElementById('profile-email');
            const passInput = document.getElementById('profile-pass');
            const agendaInput = document.getElementById('profile-agenda');

            if (!emailInput || !passInput || !agendaInput) return;

            const email = emailInput.value;
            const pass = passInput.value;
            const agenda = agendaInput.value;

            if (!pass) { alert("Senha n√£o pode ser vazia!"); return; }

            const payload = { 
                id: state.currentUser.id, 
                nome: state.currentUser.nome, 
                email, 
                senha: pass, 
                agenda, 
                ativo: true 
            };
            
            state.currentUser = { ...state.currentUser, email, senha: pass, agenda };
            state.consegs = state.consegs.map(c => String(c.id) === String(payload.id) ? {...c, ...payload} : c);

            state.loading = true;
            render();

            try {
                await fetch(DIRECT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: 'save_conseg', payload })
                });
                alert('Dados atualizados');
                fetchDataJSONP(true);
                render();
            } catch (e) { 
                alert("Erro ao salvar."); 
                state.loading = false; 
                render(); 
            }
        }

        // --- OUVIDORIA ---
        function renderOuvidoria() {
            if (state.ouvidoriaView === 'login') {
                return `
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl space-y-6 max-w-md mx-auto animate-fade-in">
                        <h2 class="text-3xl font-bold text-center text-primary dark:text-blue-400">Minha Ouvidoria</h2>
                        <input type="text" oninput="state.ouvidoriaUser = maskName(this.value); this.value = state.ouvidoriaUser" placeholder="PRIMEIRO NOME" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                        <input type="text" oninput="state.ouvidoriaPass = maskUserPassword(this.value); this.value = state.ouvidoriaPass" placeholder="AAA-999999" class="w-full p-4 border rounded-xl dark:bg-gray-700 font-bold">
                        <div class="grid grid-cols-1 gap-4">
                            <button onclick="handleOuvidoriaLogin('list')" class="bg-blue-600 text-white p-5 rounded-xl font-bold">Buscar Registros</button>
                            <button onclick="handleOuvidoriaLogin('form')" class="bg-green-600 text-white p-5 rounded-xl font-bold">Novo Registro</button>
                            <button onclick="setScreen('home')" class="bg-gray-500 text-white p-5 rounded-xl font-bold">Voltar</button>
                        </div>
                    </div>
                `;
            }
            return `<p class="text-center font-bold">Funcionalidade ativa...</p>`;
        }

        function handleOuvidoriaLogin(view) {
            if (state.ouvidoriaUser && /^[A-Z]{3}-[0-9]{6}$/.test(state.ouvidoriaPass)) { state.ouvidoriaView = view; render(); fetchDataJSONP(); }
            else alert("Informe nome e senha v√°lida (AAA-999999)!");
        }

        function updateRegStatus(id, newStatus) {
            const reg = state.registrations.find(r => String(r.id) === String(id));
            if (!reg) return;
            
            // Atualiza√ß√£o local para feedback instant√¢neo
            reg.status = newStatus;
            reg.updatedAt = new Date().toISOString();
            
            // Feedback visual no card (muda cor da borda imediatamente)
            const card = document.getElementById(`card-${id}`);
            if (card) {
                card.classList.remove('status-border-pendente', 'status-border-andamento', 'status-border-concluido');
                card.classList.add(getStatusBorderClass(newStatus));
            }

            // Envio para a nuvem (payload completo conforme instru√ß√£o)
            fetch(DIRECT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ type: 'registration', payload: reg }) 
            });
            
            // Notifica√ß√£o discreta (opcional, pode ser alert conforme pedido)
            alert('Dados atualizados'); 
            
            // Renderiza apenas se n√£o quisermos feedback imediato visual local, 
            // mas como j√° atualizamos a borda, chamamos o render para sincronizar o resto do estado.
            render();
        }

        function deleteReg(id) {
            if (confirm("Excluir permanentemente?")) {
                fetch(DIRECT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'delete_registration', payload: { id } }) });
                alert('Registro realizado!'); 
                state.registrations = state.registrations.filter(r => String(r.id) !== String(id));
                render();
                setTimeout(() => fetchDataJSONP(true), 1500);
            }
        }

        function handlePMSCCidadao() { window.open("https://www.pm.sc.gov.br/"); }
        function handleSinesp() { window.open("https://play.google.com/store/apps/details?id=br.gov.sinesp.cidadao.android"); }
        function handleCelesc() { window.open("https://play.google.com/store/apps/details?id=br.com.celesc.app"); }

        function renderEmergencia() { return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-4 animate-fade-in"><h2 class="text-3xl font-bold text-red-600 mb-6">üö® EMERG√äNCIA</h2><button onclick="window.open('tel:190')" class="w-full p-5 bg-gray-100 dark:bg-gray-700 rounded-xl flex justify-between items-center font-bold">190 Pol√≠cia Militar üìû</button><button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold">Voltar</button></div>`; }
        function renderServicos() { return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-4 animate-fade-in"><h2 class="text-3xl font-bold text-teal-600 mb-6">üõ†Ô∏è SERVI√áOS</h2><button onclick="window.open('tel:34313233')" class="w-full p-5 bg-gray-100 dark:bg-gray-700 rounded-xl flex justify-between items-center font-bold">Prefeitura Joinville üìû</button><button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold">Voltar</button></div>`; }
        function renderAgenda() { return `<div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl space-y-6 animate-fade-in"><h2 class="text-3xl font-bold text-purple-600 mb-6">üìÖ Agenda CONSEG</h2><button onclick="setScreen('home')" class="w-full p-5 bg-gray-500 text-white rounded-xl font-bold">Voltar</button></div>`; }

        // INICIALIZA√á√ÉO
        setInterval(() => { state.currentTime = new Date(); if (state.screen === 'home') render(); }, 30000);
        setInterval(() => fetchDataJSONP(), 60000);
        fetchDataJSONP();
        render();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>